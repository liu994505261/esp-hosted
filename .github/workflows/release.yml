name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:v5.5
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Prepare release directory
      run: |
        mkdir -p release_artifacts
        apt-get update && apt-get install -y build-essential
    
    - name: Build firmware variants
      run: |
        # 直接使用现有的构建脚本，无需修改
        
        # ESP32 SDIO
        export IDF_TARGET=esp32
        .gitlab/ci/build_firmware.sh esp32
        cp esp_hosted_ng/esp/esp_driver/network_adapter/build/network_adapter.bin \
           release_artifacts/network_adapter_esp32_sdio.bin
        
        # ESP32 SPI  
        .gitlab/ci/build_firmware.sh esp32 spi
        cp esp_hosted_ng/esp/esp_driver/network_adapter/build/network_adapter.bin \
           release_artifacts/network_adapter_esp32_spi.bin
        
        # ESP32-S2 SPI
        export IDF_TARGET=esp32s2
        .gitlab/ci/build_firmware.sh esp32s2
        cp esp_hosted_ng/esp/esp_driver/network_adapter/build/network_adapter.bin \
           release_artifacts/network_adapter_esp32s2_spi.bin
        
        # ESP32-S3 SPI
        export IDF_TARGET=esp32s3
        .gitlab/ci/build_firmware.sh esp32s3
        cp esp_hosted_ng/esp/esp_driver/network_adapter/build/network_adapter.bin \
           release_artifacts/network_adapter_esp32s3_spi.bin
        
        # ESP32-C2 SPI
        export IDF_TARGET=esp32c2
        .gitlab/ci/build_firmware.sh esp32c2
        cp esp_hosted_ng/esp/esp_driver/network_adapter/build/network_adapter.bin \
           release_artifacts/network_adapter_esp32c2_spi.bin
        
        # ESP32-C3 SPI
        export IDF_TARGET=esp32c3
        .gitlab/ci/build_firmware.sh esp32c3
        cp esp_hosted_ng/esp/esp_driver/network_adapter/build/network_adapter.bin \
           release_artifacts/network_adapter_esp32c3_spi.bin
        
        # ESP32-C6 SDIO
        export IDF_TARGET=esp32c6
        .gitlab/ci/build_firmware.sh esp32c6
        cp esp_hosted_ng/esp/esp_driver/network_adapter/build/network_adapter.bin \
           release_artifacts/network_adapter_esp32c6_sdio.bin
        
        # ESP32-C6 SPI
        .gitlab/ci/build_firmware.sh esp32c6 spi
        cp esp_hosted_ng/esp/esp_driver/network_adapter/build/network_adapter.bin \
           release_artifacts/network_adapter_esp32c6_spi.bin
    
    - name: Build host drivers
      run: |
        cd esp_hosted_ng/host
        
        # Build SDIO driver
        make clean || true
        make || echo "SDIO build may fail in container, continuing..."
        find . -name "*.ko" -exec cp {} ../../release_artifacts/ \; || true
        
        # Build SPI driver  
        make clean || true
        make target=spi || echo "SPI build may fail in container, continuing..."
        find . -name "*.ko" -exec bash -c 'cp "$1" "../../release_artifacts/spi_$(basename "$1")"' _ {} \; || true
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: release_artifacts/*
        generate_release_notes: true
        body: |
          ## ESP-Hosted Release ${{ github.ref_name }}
          
          This release includes pre-built firmware binaries for various ESP32 chips and host drivers.
          
          ### Firmware Binaries:
          - ESP32 (SDIO/SPI)
          - ESP32-S2 (SPI)
          - ESP32-S3 (SPI) 
          - ESP32-C2 (SPI)
          - ESP32-C3 (SPI)
          - ESP32-C6 (SDIO/SPI)
          
          ### Host Drivers:
          - Linux SDIO driver
          - Linux SPI driver
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}